services:
  anvil:
    container_name: anvil-ethereum-node
    profiles:
      - sandbox
    image: aztecprotocol/aztec:3.0.0-devnet.2
    ports:
      - "8545:8545"
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        anvil --host 0.0.0.0 --silent
    restart: unless-stopped
    networks:
      - aztec-network
  aztec-sandbox-node:
    container_name: aztec-sandbox-node
    profiles:
      - sandbox
    image: aztecprotocol/aztec:3.0.0-devnet.2
    ports:
      - "8080:8080"
      - "40400:40400"
      - "40400:40400/udp"
    environment:
      - L1_CHAIN_ID=31337
      - ETHEREUM_HOSTS=http://anvil:8545
      - AZTEC_PORT=8080
      - P2P_PORT=40400
      - NO_PXE=true
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        node --no-warnings /usr/src/yarn-project/aztec/dest/bin/index.js start --sandbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    depends_on:
      - anvil
    restart: unless-stopped
    networks:
      - aztec-network
  api:
    container_name: orderflow-api
    profiles:
      - api
    build:
      context: ./packages/api
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./data:/data 
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    networks:
      - aztec-network

networks:
  aztec-network:
    driver: bridge