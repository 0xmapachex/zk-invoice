name: CLI/ API Tests for Aztec Invoice System

on:
    push:
      branches:
        - main
    pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
    setup-and-run:
      strategy:
        matrix:
          os: [ubuntu-latest]
          threads: [12]

      runs-on: ${{ matrix.os }}
      timeout-minutes: 60

      concurrency:
        group: job-${{ github.workflow }}-${{ github.ref_name }}-${{ matrix.os }}-${{ matrix.threads }}
        cancel-in-progress: false

      steps:
        - name: Checkout repository
          uses: actions/checkout@v3
          with:
            fetch-depth: 0
            submodules: recursive

        - name: Environment Setup (Install Bun & Aztec, Build Project, Run Sandbox)
          uses: ./.github/actions/aztec-setup
          with:
            start-sandbox: 'true'
            start-api: 'true'
        
        - name: Add sandbox .env
          run: cd packages/cli && cat .env.example > .env

        - name: Deploy token contracts
          run: cd packages/cli && bun run setup:deploy
        
        - name: Deploy registry contract
          run: cd packages/cli && bun run deploy:registry
        
        - name: Mint tokens
          run: cd packages/cli && bun run setup:mint
        
        - name: Create Invoice
          run: cd packages/cli && bun run invoice:create
        
        - name: Pay Invoice
          run: cd packages/cli && bun run invoice:pay
  